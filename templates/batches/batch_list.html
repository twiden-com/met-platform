<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Medha Edu Tech - Batch Management</title>
    <link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Sans:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/carbon-components/10.58.12/css/carbon-components.min.css">
    <link rel="stylesheet" href="https://unpkg.com/@carbon/styles@1.32.0/css/styles.min.css">
    <style>
        :root {
            --color-navy: #1e3a8a;
            --color-orange: #f97316;
            --color-white: #ffffff;
            --color-gray-bg: #f2f4f8;
            --color-success: #24a148;
            --color-warning: #f1c21b;
            --color-error: #da1e28;
            --color-info: #0f62fe;
        }

        * {
            box-sizing: border-box;
        }

        body {
            margin: 0;
            padding: 0;
            font-family: 'IBM Plex Sans', sans-serif;
            background: var(--color-gray-bg);
        }

        /* Fixed Header */
        .app-header {
            background: var(--color-navy);
            color: white;
            padding: 1rem 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            z-index: 1000;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        .header-left {
            display: flex;
            align-items: center;
            gap: 1.5rem;
        }

        .back-link {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            color: rgba(255, 255, 255, 0.9);
            text-decoration: none;
            font-weight: 500;
            transition: color 0.15s ease;
            padding: 0.5rem;
            border-radius: 4px;
        }

        .back-link:hover {
            color: white;
            background: rgba(255, 255, 255, 0.1);
        }

        .page-title {
            font-size: 1rem;
            font-weight: 600;
            color: white;
            margin: 0;
        }

        .logo {
            font-size: 1.5rem;
            font-weight: 700;
            color: white;
            letter-spacing: -0.02em;
        }

        .logo-accent {
            color: var(--color-orange);
        }

        /* Main Content Area */
        .main-wrapper {
            margin-top: 80px; /* Space for fixed header */
            height: calc(100vh - 80px);
            display: flex;
            flex-direction: column;
        }

        .content-container {
            max-width: 700px;
            margin: 0 auto;
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            padding: 0 2rem;
        }

        /* Fixed Top Section */
        .top-section {
            padding: 2rem 0 1rem 0;
            background: var(--color-gray-bg);
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .content-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
        }

        .content-title {
            font-size: 1.5rem;
            font-weight: 600;
            color: #161616;
            margin: 0;
        }

        .new-batch-btn {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            background: var(--color-navy);
            color: white;
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: 4px;
            font-size: 0.875rem;
            font-weight: 500;
            cursor: pointer;
            transition: background-color 0.15s ease;
            text-decoration: none;
        }

        .new-batch-btn:hover {
            background: #1d4ed8;
            color: white;
        }

        .filters-section {
            background: white;
            border-radius: 8px;
            border: 1px solid #e0e0e0;
            padding: 1rem;
        }

        .filters-grid {
            display: grid;
            grid-template-columns: 2fr 1fr 1fr;
            gap: 1rem;
            align-items: end;
        }

        .bx--label {
            display: block;
            font-size: 0.75rem;
            font-weight: 500;
            color: #6f6f6f;
            margin-bottom: 0.5rem;
            text-transform: uppercase;
            letter-spacing: 0.02em;
        }

        .bx--text-input,
        .bx--select-input {
            width: 100%;
            height: 2.5rem;
            padding: 0 1rem;
            font-size: 0.875rem;
            font-family: inherit;
            color: #161616;
            background-color: #f4f4f4;
            border: none;
            border-bottom: 1px solid #8d8d8d;
            outline: none;
            transition: all 0.11s cubic-bezier(0.2, 0, 0.38, 0.9);
        }

        .bx--text-input:focus,
        .bx--select-input:focus {
            border-bottom: 2px solid #0f62fe;
            background-color: white;
        }

        .bx--select {
            position: relative;
        }

        .bx--select__arrow {
            position: absolute;
            top: 50%;
            right: 1rem;
            transform: translateY(-50%);
            pointer-events: none;
            fill: #161616;
        }

        /* Scrollable Batch List */
        .batch-list-container {
            flex: 1;
            overflow-y: auto;
            padding: 1rem 0 2rem 0;
        }

        .batch-list {
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
        }

        /* Simplified Batch Cards */
        .batch-card {
            background: white;
            border-radius: 6px;
            border: 1px solid #e0e0e0;
            padding: 1rem;
            transition: all 0.15s ease;
            cursor: pointer;
        }

        .batch-card:hover {
            border-color: var(--color-navy);
            box-shadow: 0 2px 8px rgba(30, 58, 138, 0.08);
        }

        .batch-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 0.75rem;
        }

        .batch-title {
            font-size: 1rem;
            font-weight: 600;
            color: #161616;
            margin: 0 0 0.25rem 0;
        }

        .batch-id {
            font-size: 0.75rem;
            color: #6f6f6f;
            font-weight: 400;
        }

        .batch-status {
            display: flex;
            flex-direction: column;
            align-items: flex-end;
            gap: 0.25rem;
        }

        .status-badge {
            padding: 0.125rem 0.5rem;
            border-radius: 10px;
            font-size: 0.6875rem;
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 0.02em;
        }

        .status-demo {
            background: #fef3c7;
            color: #92400e;
        }

        .status-started {
            background: #d1fae5;
            color: #065f46;
        }

        .status-closed {
            background: #fee2e2;
            color: #991b1b;
        }

        .days-text {
            font-size: 0.6875rem;
            color: #6f6f6f;
            font-weight: 500;
        }

        .batch-meta {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr 1fr;
            gap: 0.75rem;
            font-size: 0.75rem;
        }

        .meta-item {
            display: flex;
            flex-direction: column;
            gap: 0.125rem;
        }

        .meta-label {
            color: #6f6f6f;
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 0.02em;
            font-size: 0.6875rem;
        }

        .meta-value {
            color: #161616;
            font-weight: 400;
        }

        .meta-value.empty {
            color: #a8a8a8;
            font-style: italic;
        }

        .batch-actions {
            display: flex;
            gap: 0.5rem;
            margin-top: 0.75rem;
            padding-top: 0.75rem;
            border-top: 1px solid #f0f0f0;
        }

        .action-btn {
            padding: 0.375rem 0.75rem;
            border: 1px solid #e0e0e0;
            background: white;
            color: #161616;
            font-size: 0.6875rem;
            font-weight: 500;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.15s ease;
        }

        .action-btn:hover {
            border-color: var(--color-navy);
            color: var(--color-navy);
        }

        .action-btn.primary {
            background: var(--color-navy);
            color: white;
            border-color: var(--color-navy);
        }

        .action-btn.primary:hover {
            background: #1d4ed8;
        }

        /* Loading & Empty States */
        .loading-container {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 200px;
            gap: 0.75rem;
            color: #6f6f6f;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .loading-spinner {
            animation: spin 1s linear infinite;
        }

        .empty-state {
            text-align: center;
            padding: 3rem 2rem;
            color: #6f6f6f;
        }

        .empty-state-title {
            font-size: 1.125rem;
            font-weight: 600;
            color: #161616;
            margin-bottom: 0.5rem;
        }

        .empty-state-message {
            margin-bottom: 1.5rem;
        }

        /* Responsive */
        @media (max-width: 600px) {
            .app-header {
                padding: 1rem;
                flex-direction: column;
                gap: 0.75rem;
                align-items: flex-start;
            }

            .main-wrapper {
                margin-top: 120px;
                height: calc(100vh - 120px);
            }

            .content-container {
                padding: 0 1rem;
            }

            .content-header {
                flex-direction: column;
                gap: 1rem;
                align-items: stretch;
            }

            .filters-grid {
                grid-template-columns: 1fr;
                gap: 0.5rem;
            }

            .batch-meta {
                grid-template-columns: 1fr 1fr;
                gap: 0.5rem;
            }

            .batch-actions {
                flex-wrap: wrap;
            }

            .logo {
                display: none;
            }
        }
    </style>
</head>
<body>
    <!-- Fixed Header -->
    <div class="app-header">
        <div class="header-left">
            <a href="/dashboard" class="back-link">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
                    <path d="M20 11H7.83l5.59-5.59L12 4l-8 8 8 8 1.42-1.41L7.83 13H20v-2z"/>
                </svg>
                Dashboard
            </a>
            <h1 class="page-title">Batch Management</h1>
        </div>
        <div class="logo">
            Medha<span class="logo-accent">EduTech</span>
        </div>
    </div>

    <!-- Main Content -->
    <div class="main-wrapper">
        <div class="content-container">
            
            <!-- Sticky Top Section -->
            <div class="top-section">
                <div class="content-header">
                    <h2 class="content-title">All Batches</h2>
                    <a href="/batches/new" class="new-batch-btn">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                            <path d="M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6v2z"/>
                        </svg>
                        New Batch
                    </a>
                </div>

                <div class="filters-section">
                    <div class="filters-grid">
                        <div>
                            <label for="search" class="bx--label">Search Batches</label>
                            <input type="text" id="search" class="bx--text-input" placeholder="Search by name or trainer...">
                        </div>
                        <div>
                            <label for="status-filter" class="bx--label">Status</label>
                            <div class="bx--select">
                                <select id="status-filter" class="bx--select-input">
                                    <option value="">All</option>
                                    <option value="Demo">Demo</option>
                                    <option value="Started">Started</option>
                                    <option value="Closed">Closed</option>
                                </select>
                                <svg class="bx--select__arrow" width="16" height="16" viewBox="0 0 16 16">
                                    <path d="m8 11L3 6l.7-.7L8 9.6l4.3-4.3L13 6z"></path>
                                </svg>
                            </div>
                        </div>
                        <div>
                            <label for="trainer-filter" class="bx--label">Trainer</label>
                            <div class="bx--select">
                                <select id="trainer-filter" class="bx--select-input">
                                    <option value="">All</option>
                                    <option value="Mrs. Mounika">Mrs. Mounika</option>
                                    <option value="Mr. Shahul">Mr. Shahul</option>
                                    <option value="Mr. Chaitanya Vaddi">Mr. Chaitanya Vaddi</option>
                                </select>
                                <svg class="bx--select__arrow" width="16" height="16" viewBox="0 0 16 16">
                                    <path d="m8 11L3 6l.7-.7L8 9.6l4.3-4.3L13 6z"></path>
                                </svg>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Scrollable Batch List -->
            <div class="batch-list-container">
                <div id="batch-list" class="batch-list">
                    <div class="loading-container">
                        <svg class="loading-spinner" width="24" height="24" viewBox="0 0 24 24" fill="currentColor">
                            <path d="M12 22A10 10 0 1 1 22 12a10 10 0 0 1-10 10zm0-2a8 8 0 1 0-8-8 8 8 0 0 0 8 8z" opacity="0.3"/>
                            <path d="M12 2a10 10 0 0 1 10 10h-2A8 8 0 0 0 12 4V2z"/>
                        </svg>
                        <span>Loading batches...</span>
                    </div>
                </div>
            </div>

        </div>
    </div>

    <script>
        class BatchManagement {
            constructor() {
                this.batches = [];
                this.filteredBatches = [];
                this.initializeElements();
                this.bindEvents();
                this.loadBatches();
            }

            initializeElements() {
                this.batchList = document.getElementById('batch-list');
                this.searchInput = document.getElementById('search');
                this.statusFilter = document.getElementById('status-filter');
                this.trainerFilter = document.getElementById('trainer-filter');
            }

            bindEvents() {
                this.searchInput.addEventListener('input', () => this.filterBatches());
                this.statusFilter.addEventListener('change', () => this.filterBatches());
                this.trainerFilter.addEventListener('change', () => this.filterBatches());
            }

            async loadBatches() {
                try {
                    await new Promise(resolve => setTimeout(resolve, 1500));

                    const response = await fetch('/batches/list/api', {
                        method: 'GET',
                    });

                    // Parse the JSON response
                    const data = await response.json();

                    if (response.ok && data) {
                        // Success case
                        this.batches = data
                    } else {
                        // Error case - show the error message from server
                        this.batches = []
                        const errorMessage = data.message || 'Failed to create batch';
                        this.showAlert(errorMessage, 'error');
                        this.scrollToError();
                    }

                    this.filteredBatches = [...this.batches];
                    this.renderBatches();
                } catch (error) {
                    console.error('Error loading batches:', error);
                    this.renderError();
                }
            }

            filterBatches() {
                const searchTerm = this.searchInput.value.toLowerCase();
                const statusFilter = this.statusFilter.value;
                const trainerFilter = this.trainerFilter.value;

                this.filteredBatches = this.batches.filter(batch => {
                    const matchesSearch = !searchTerm || 
                        batch.batch_name.toLowerCase().includes(searchTerm) ||
                        batch.trainer.toLowerCase().includes(searchTerm) ||
                        batch.id.toLowerCase().includes(searchTerm);
                    
                    const matchesStatus = !statusFilter || batch.status === statusFilter;
                    const matchesTrainer = !trainerFilter || batch.trainer === trainerFilter;

                    return matchesSearch && matchesStatus && matchesTrainer;
                });

                this.renderBatches();
            }

            renderBatches() {
                if (this.filteredBatches.length === 0) {
                    this.renderEmptyState();
                    return;
                }

                const batchCards = this.filteredBatches.map(batch => this.createBatchCard(batch)).join('');
                this.batchList.innerHTML = batchCards;
                this.bindCardEvents();
            }

            createBatchCard(batch) {
                const daysInfo = this.calculateDaysInfo(batch);
                const statusClass = `status-${batch.status.toLowerCase()}`;
                
                return `
                    <div class="batch-card" data-batch-id="${batch.id}">
                        <div class="batch-header">
                            <div>
                                <h3 class="batch-title">${batch.batch_name}</h3>
                                <div class="batch-id">${batch.id}</div>
                            </div>
                            <div class="batch-status">
                                <div class="status-badge ${statusClass}">${batch.status}</div>
                                <div class="days-text">${daysInfo}</div>
                            </div>
                        </div>
                        
                        <div class="batch-meta">
                            <div class="meta-item">
                                <div class="meta-label">Trainer</div>
                                <div class="meta-value">${batch.trainer}</div>
                            </div>
                            <div class="meta-item">
                                <div class="meta-label">Mode</div>
                                <div class="meta-value ${!batch.mode ? 'empty' : ''}">${batch.mode || 'Not set'}</div>
                            </div>
                            <div class="meta-item">
                                <div class="meta-label">Time</div>
                                <div class="meta-value ${batch.class_time === 'Not Yet' ? 'empty' : ''}">${batch.class_time}</div>
                            </div>
                            <div class="meta-item">
                                <div class="meta-label">Campus</div>
                                <div class="meta-value ${!batch.batch_campus ? 'empty' : ''}">${batch.batch_campus || 'Not set'}</div>
                            </div>
                        </div>
                        
                        <div class="batch-actions">
                            <button class="action-btn primary" onclick="viewBatch('${batch.id}')">View</button>
                            <button class="action-btn" onclick="editBatch('${batch.id}')">Edit</button>
                            <button class="action-btn" onclick="manageBatch('${batch.id}')">Manage</button>
                            ${batch.whatsapp_group_link ? `<button class="action-btn" onclick="openWhatsApp('${batch.whatsapp_group_link}')">WhatsApp</button>` : ''}
                        </div>
                    </div>
                `;
            }

            calculateDaysInfo(batch) {
                const today = new Date();
                const startDate = new Date(batch.start_date);
                const diffTime = today - startDate;
                const diffDays = Math.floor(diffTime / (1000 * 60 * 60 * 24));

                if (batch.status === 'Demo') {
                    if (diffDays < 0) {
                        return `Starts in ${Math.abs(diffDays)} days`;
                    } else {
                        return `Demo phase`;
                    }
                } else if (batch.status === 'Started') {
                    if (diffDays >= 0) {
                        return `Day ${diffDays + 1}`;
                    } else {
                        return `Starts in ${Math.abs(diffDays)} days`;
                    }
                } else if (batch.status === 'Closed') {
                    return 'Completed';
                }
                
                return '';
            }

            formatDate(dateString) {
                if (!dateString) return '';
                const date = new Date(dateString);
                return date.toLocaleDateString('en-US', { 
                    year: 'numeric', 
                    month: 'short', 
                    day: 'numeric' 
                });
            }

            renderEmptyState() {
                this.batchList.innerHTML = `
                    <div class="empty-state">
                        <h3 class="empty-state-title">No batches found</h3>
                        <p class="empty-state-message">
                            ${this.batches.length === 0 ? 
                                'Get started by creating your first batch.' : 
                                'Try adjusting your search or filter criteria.'
                            }
                        </p>
                        ${this.batches.length === 0 ? 
                            '<a href="/batches/new" class="new-batch-btn">Create First Batch</a>' : 
                            ''
                        }
                    </div>
                `;
            }

            renderError() {
                this.batchList.innerHTML = `
                    <div class="empty-state">
                        <h3 class="empty-state-title">Failed to load batches</h3>
                        <p class="empty-state-message">
                            There was an error loading the batch data. Please try refreshing the page.
                        </p>
                        <button class="new-batch-btn" onclick="window.location.reload()">Refresh Page</button>
                    </div>
                `;
            }

            bindCardEvents() {
                document.querySelectorAll('.batch-card').forEach(card => {
                    card.addEventListener('click', (e) => {
                        if (!e.target.closest('button')) {
                            const batchId = card.dataset.batchId;
                            viewBatch(batchId);
                        }
                    });
                });
            }
        }

        // Global functions for batch actions
        function viewBatch(batchId) {
            console.log('Viewing batch:', batchId);
        }

        function editBatch(batchId) {
            console.log('Editing batch:', batchId);
        }

        function manageBatch(batchId) {
            console.log('Managing batch:', batchId);
        }

        function openWhatsApp(link) {
            if (link) {
                window.open(link, '_blank');
            }
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            new BatchManagement();
        });
    </script>
</body>
</html>