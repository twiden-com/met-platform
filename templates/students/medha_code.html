<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Medha Code - Practice Coding</title>
    <link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Sans:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --color-navy: #1e3a8a;
            --color-orange: #f97316;
            --color-white: #ffffff;
            --color-gray-bg: #f2f4f8;
            --color-border: #e0e0e0;
            --color-text-primary: #161616;
            --color-text-secondary: #6f6f6f;
            --color-blue: #0f62fe;
            --color-green: #24a148;
            --color-red: #da1e28;
            --color-yellow: #f1c21b;
            --color-purple: #8a3ffc;
        }

        * {
            box-sizing: border-box;
        }

        body {
            margin: 0;
            padding: 0;
            font-family: 'IBM Plex Sans', sans-serif;
            background: var(--color-gray-bg);
            min-height: 100vh;
        }

        .app-header {
            background: var(--color-navy);
            color: white;
            padding: 1rem 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: sticky;
            top: 0;
            z-index: 1000;
        }

        .header-left {
            display: flex;
            align-items: center;
            gap: 1.5rem;
        }

        .back-link {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            color: rgba(255, 255, 255, 0.9);
            text-decoration: none;
            font-weight: 500;
            transition: color 0.15s ease;
            padding: 0.5rem;
            border-radius: 4px;
        }

        .back-link:hover {
            color: white;
            background: rgba(255, 255, 255, 0.1);
        }

        .page-title {
            font-size: 1.25rem;
            font-weight: 600;
            color: white;
            margin: 0;
        }

        .logo {
            font-size: 1.5rem;
            font-weight: 700;
            color: white;
            letter-spacing: -0.02em;
        }

        .logo-accent {
            color: var(--color-orange);
        }

        /* Main Layout - Two Column Layout */
        .main-container {
            display: grid;
            grid-template-columns: 1fr 400px;
            height: calc(100vh - 72px);
            overflow: hidden;
        }

        /* Column 1: Content Area with Enhanced Tabs */
        .content-column {
            background: white;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .content-header {
            border-bottom: 1px solid var(--color-border);
            background: #fafbfc;
        }

        .tab-navigation {
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 0.5rem;
            border-bottom: 1px solid var(--color-border);
            padding: 0 1rem;
        }

        .tab-buttons {
            display: flex;
            gap: 0.5rem;
        }

        .tab-button {
            padding: 0.75rem 1.5rem;
            border: none;
            background: transparent;
            color: var(--color-text-secondary);
            font-size: 0.875rem;
            font-weight: 500;
            cursor: pointer;
            border-bottom: 3px solid transparent;
            transition: all 0.15s ease;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .tab-button.active {
            color: var(--color-blue);
            border-bottom-color: var(--color-blue);
            background: rgba(15, 98, 254, 0.05);
        }

        .tab-button:hover:not(.active) {
            color: var(--color-text-primary);
            background: #f3f4f6;
        }

        .challenge-controls {
            display: flex;
            gap: 1rem;
            align-items: center;
        }

        .control-group {
            display: flex;
            flex-direction: column;
            gap: 0.25rem;
            min-width: 160px;
        }

        .control-label {
            font-size: 0.65rem;
            font-weight: 600;
            color: var(--color-text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .dropdown {
            width: 100%;
            padding: 0.5rem 0.75rem;
            border: 1px solid #d1d5db;
            border-radius: 4px;
            font-size: 0.8rem;
            color: var(--color-text-primary);
            background: white;
            transition: all 0.15s ease;
            appearance: none;
            background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%236b7280' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='m6 8 4 4 4-4'/%3e%3c/svg%3e");
            background-position: right 0.5rem center;
            background-repeat: no-repeat;
            background-size: 1.2em 1.2em;
            padding-right: 2rem;
        }

        .dropdown:focus {
            outline: none;
            border-color: var(--color-blue);
            box-shadow: 0 0 0 3px rgba(15, 98, 254, 0.1);
        }

        .dropdown:disabled {
            background-color: #f9fafb;
            color: #9ca3af;
            cursor: not-allowed;
        }

        .content-container {
            flex: 1;
            overflow: hidden;
            position: relative;
        }

        .tab-content {
            display: none;
            height: 100%;
            overflow: hidden;
        }

        .tab-content.active {
            display: block;
        }

        .content-iframe {
            width: 100%;
            height: 100%;
            border: none;
            background: white;
        }

        .empty-state {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100%;
            padding: 2rem;
            text-align: center;
            color: var(--color-text-secondary);
        }

        .empty-icon {
            width: 64px;
            height: 64px;
            color: #d1d5db;
            margin-bottom: 1rem;
        }

        .empty-title {
            font-size: 1rem;
            font-weight: 600;
            color: var(--color-text-primary);
            margin: 0 0 0.5rem 0;
        }

        .empty-description {
            font-size: 0.875rem;
            line-height: 1.4;
        }

        /* Column 2: AI Chatbot */
        .chat-column {
            background: white;
            border-left: 1px solid var(--color-border);
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .chat-header {
            padding: 1rem 1.5rem;
            border-bottom: 1px solid var(--color-border);
            background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
            position: relative;
            overflow: hidden;
        }

        .chat-header::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: linear-gradient(90deg, var(--color-blue), var(--color-purple));
        }

        .chat-title {
            font-size: 1rem;
            font-weight: 600;
            color: var(--color-text-primary);
            margin: 0;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .chat-icon {
            width: 20px;
            height: 20px;
            color: var(--color-blue);
        }

        .chat-container {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .chat-messages {
            flex: 1;
            overflow-y: auto;
            padding: 1rem;
            display: flex;
            flex-direction: column;
            gap: 1rem;
            background: #fafbfc;
        }

        .chat-message {
            display: flex;
            gap: 0.75rem;
            align-items: flex-start;
        }

        .chat-message.user {
            flex-direction: row-reverse;
        }

        .message-avatar {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.75rem;
            font-weight: 600;
            flex-shrink: 0;
        }

        .message-avatar.user {
            background: var(--color-blue);
            color: white;
        }

        .message-avatar.assistant {
            background: var(--color-purple);
            color: white;
        }

        .message-content {
            max-width: 80%;
            padding: 0.75rem 1rem;
            border-radius: 12px;
            font-size: 0.875rem;
            line-height: 1.4;
            word-wrap: break-word;
        }

        .chat-message.user .message-content {
            background: var(--color-blue);
            color: white;
            border-bottom-right-radius: 4px;
        }

        .chat-message.assistant .message-content {
            background: white;
            color: var(--color-text-primary);
            border: 1px solid var(--color-border);
            border-bottom-left-radius: 4px;
        }

        .message-content pre {
            background: rgba(0, 0, 0, 0.05);
            padding: 0.5rem;
            border-radius: 4px;
            overflow-x: auto;
            margin: 0.5rem 0;
        }

        .message-content code {
            background: rgba(0, 0, 0, 0.05);
            padding: 0.125rem 0.25rem;
            border-radius: 3px;
            font-family: 'Courier New', monospace;
            font-size: 0.8em;
        }

        .chat-input-container {
            padding: 1rem;
            border-top: 1px solid var(--color-border);
            background: white;
        }

        .chat-input-wrapper {
            display: flex;
            gap: 0.5rem;
            align-items: flex-end;
        }

        .chat-input {
            flex: 1;
            min-height: 40px;
            max-height: 120px;
            padding: 0.75rem;
            border: 1px solid var(--color-border);
            border-radius: 20px;
            font-size: 0.875rem;
            font-family: inherit;
            resize: none;
            outline: none;
            transition: all 0.15s ease;
        }

        .chat-input:focus {
            border-color: var(--color-blue);
            box-shadow: 0 0 0 3px rgba(15, 98, 254, 0.1);
        }

        .chat-input::placeholder {
            color: var(--color-text-secondary);
        }

        .chat-send-btn {
            width: 40px;
            height: 40px;
            border: none;
            background: var(--color-blue);
            color: white;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.15s ease;
            flex-shrink: 0;
        }

        .chat-send-btn:hover:not(:disabled) {
            background: #0353e9;
            transform: scale(1.05);
        }

        .chat-send-btn:disabled {
            background: #d1d5db;
            cursor: not-allowed;
            transform: none;
        }

        .chat-welcome {
            text-align: center;
            padding: 2rem;
            color: var(--color-text-secondary);
        }

        .chat-welcome-icon {
            width: 48px;
            height: 48px;
            color: var(--color-blue);
            margin: 0 auto 1rem;
        }

        .chat-welcome h3 {
            font-size: 1rem;
            font-weight: 600;
            color: var(--color-text-primary);
            margin: 0 0 0.5rem 0;
        }

        .chat-welcome p {
            font-size: 0.875rem;
            line-height: 1.4;
            margin: 0;
        }

        .typing-indicator {
            display: flex;
            gap: 0.25rem;
            padding: 0.75rem 1rem;
            background: white;
            border: 1px solid var(--color-border);
            border-radius: 12px;
            border-bottom-left-radius: 4px;
            max-width: 80%;
        }

        .typing-dot {
            width: 8px;
            height: 8px;
            background: var(--color-text-secondary);
            border-radius: 50%;
            animation: typingAnimation 1.4s infinite ease-in-out;
        }

        .typing-dot:nth-child(2) {
            animation-delay: 0.2s;
        }

        .typing-dot:nth-child(3) {
            animation-delay: 0.4s;
        }

        @keyframes typingAnimation {
            0%, 80%, 100% {
                opacity: 0.3;
                transform: scale(0.8);
            }
            40% {
                opacity: 1;
                transform: scale(1);
            }
        }

        /* Responsive */
        @media (max-width: 1200px) {
            .main-container {
                grid-template-columns: 1fr 350px;
            }
            
            .challenge-controls {
                flex-direction: column;
                gap: 0.5rem;
            }
            
            .control-group {
                min-width: 120px;
            }
        }

        @media (max-width: 768px) {
            .main-container {
                grid-template-columns: 1fr;
                height: auto;
            }
            
            .chat-column {
                display: none;
            }
            
            .app-header {
                padding: 1rem;
            }

            .tab-navigation {
                flex-direction: column;
                gap: 1rem;
                padding: 1rem;
            }
            
            .challenge-controls {
                flex-direction: column;
                gap: 0.5rem;
                width: 100%;
            }
            
            .control-group {
                min-width: auto;
            }
        }
    </style>
</head>
<body>
    <!-- App Header -->
    <div class="app-header">
        <div class="header-left">
            <a href="/dashboard" class="back-link">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
                    <path d="M20 11H7.83l5.59-5.59L12 4l-8 8 8 8 1.42-1.41L7.83 13H20v-2z"/>
                </svg>
                Dashboard
            </a>
            <h1 class="page-title">Medha Code</h1>
        </div>
        <div class="logo">
            Medha<span class="logo-accent">EduTech</span>
        </div>
    </div>

    <!-- Main Container - Two Column Layout -->
    <div class="main-container">
        <!-- Column 1: Content Area with Enhanced Tabs -->
        <div class="content-column">
            <div class="content-header">
                <div class="tab-navigation">
                    <div class="challenge-controls">
                        <div class="control-group">
                            <!-- <label class="control-label">Course</label> -->
                            <select class="dropdown" id="course-select">
                                <option value="python_full_stack" selected>Python Full Stack</option>
                                <option value="java_fullstack">Java Full Stack</option>
                                <option value="digital_marketing">Digital Marketing</option>
                                <option value="cybersecurity">Cybersecurity</option>
                                <option value="data_science">Data Science</option>
                                <option value="data_analytics">Data Analytics</option>
                            </select>
                        </div>
                        
                        <div class="control-group">
                            <!-- <label class="control-label">Challenge Topic</label> -->
                            <select class="dropdown" id="topic-select">
                                <option value="">Loading topics...</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="tab-buttons">
                        <button class="tab-button" onclick="switchTab('read')">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                                <path d="M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm-5 14H7v-2h7v2zm3-4H7v-2h10v2zm0-4H7V7h10v2z"/>
                            </svg>
                            Read
                        </button>
                        <button class="tab-button active" onclick="switchTab('code')">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                                <path d="M9.4 16.6L4.8 12l4.6-4.6L8 6l-6 6 6 6 1.4-1.4zm5.2 0L19.2 12l-4.6-4.6L16 6l6 6-6 6-1.4-1.4z"/>
                            </svg>
                            Code
                        </button>
                    </div>
                </div>
            </div>
            
            <div class="content-container">
                <!-- Read Tab Content -->
                <div id="read-tab" class="tab-content">
                    <div class="empty-state">
                        <svg class="empty-icon" viewBox="0 0 24 24" fill="currentColor">
                            <path d="M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm-5 14H7v-2h7v2zm3-4H7v-2h10v2zm0-4H7V7h10v2z"/>
                        </svg>
                        <h3 class="empty-title">Documentation</h3>
                        <p class="empty-description">
                            Select a course and topic to view documentation and learning materials.
                        </p>
                    </div>
                </div>
                
                <!-- Code Tab Content -->
                <div id="code-tab" class="tab-content active">
                    <div class="empty-state">
                        <svg class="empty-icon" viewBox="0 0 24 24" fill="currentColor">
                            <path d="M9.4 16.6L4.8 12l4.6-4.6L8 6l-6 6 6 6 1.4-1.4zm5.2 0L19.2 12l-4.6-4.6L16 6l6 6-6 6-1.4-1.4z"/>
                        </svg>
                        <h3 class="empty-title">Select Challenge</h3>
                        <p class="empty-description">
                            Choose a course and topic above to load the coding challenge.
                        </p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Column 2: AI Chatbot -->
        <div class="chat-column">
            <div class="chat-header">
                <h3 class="chat-title">
                    <svg class="chat-icon" viewBox="0 0 24 24" fill="currentColor">
                        <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-1 17.93c-3.94-.49-7-3.85-7-7.93 0-.62.08-1.21.21-1.79L9 15v1c0 1.1.9 2 2 2v1.93zm6.9-2.54c-.26-.81-1-1.39-1.9-1.39h-1v-3c0-.55-.45-1-1-1H8v-2h2c.55 0 1-.45 1-1V7h2c1.1 0 2-.9 2-2v-.41c2.93 1.19 5 4.06 5 7.41 0 2.08-.8 3.97-2.1 5.39z"/>
                    </svg>
                    AI Coding Assistant
                </h3>
            </div>
            
            <div class="chat-container">
                <div class="chat-messages" id="chat-messages">
                    <div class="chat-welcome">
                        <svg class="chat-welcome-icon" viewBox="0 0 24 24" fill="currentColor">
                            <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-1 17.93c-3.94-.49-7-3.85-7-7.93 0-.62.08-1.21.21-1.79L9 15v1c0 1.1.9 2 2 2v1.93zm6.9-2.54c-.26-.81-1-1.39-1.9-1.39h-1v-3c0-.55-.45-1-1-1H8v-2h2c.55 0 1-.45 1-1V7h2c1.1 0 2-.9 2-2v-.41c2.93 1.19 5 4.06 5 7.41 0 2.08-.8 3.97-2.1 5.39z"/>
                        </svg>
                        <h3>Welcome to AI Assistant!</h3>
                        <p>I'm here to help you with coding questions, explain concepts, debug issues, and provide guidance. Just type your question below to get started!</p>
                    </div>
                </div>
                
                <div class="chat-input-container">
                    <div class="chat-input-wrapper">
                        <textarea 
                            id="chat-input" 
                            class="chat-input" 
                            placeholder="Ask me anything.."
                            rows="1"></textarea>
                        <button id="chat-send-btn" class="chat-send-btn" onclick="sendMessage()">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                                <path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z"/>
                            </svg>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Load Puter.js -->
    <script src="https://js.puter.com/v2/"></script>
    
    <script>
        class MedhaCode {
            constructor() {
                this.challenges = [];
                this.currentChallenge = null;
                this.currentCodeContent = null;
                this.currentQuestionText = null;
                this.contentCheckInterval = null;
                this.chatMessages = [];
                this.isTyping = false;
                this.initializeEventListeners();
                this.initializePuter();
                this.initializeDefaults();
            }

            async initializeDefaults() {
                // Load Python Full Stack challenges by default
                await this.loadChallengesByCourse('python_full_stack');
            }

            async initializePuter() {
                try {
                    if (typeof puter !== 'undefined' && puter.ai) {
                        console.log('Puter.js loaded successfully');
                        this.addSystemMessage('MET AI Assistant ready!');
                    } else {
                        console.log('Waiting for Puter.js to load...');
                        setTimeout(() => this.initializePuter(), 1000);
                    }
                } catch (error) {
                    console.error('Error initializing Puter:', error);
                    this.addSystemMessage('AI Assistant ready!');
                }
            }

            initializeEventListeners() {
                const courseSelect = document.getElementById('course-select');
                const topicSelect = document.getElementById('topic-select');

                courseSelect.addEventListener('change', (e) => {
                    this.loadChallengesByCourse(e.target.value);
                });

                topicSelect.addEventListener('change', (e) => {
                    this.loadChallengeByTopic(e.target.value);
                });

                // Chat input listeners
                const chatInput = document.getElementById('chat-input');
                const sendBtn = document.getElementById('chat-send-btn');

                chatInput.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter' && !e.shiftKey) {
                        e.preventDefault();
                        this.sendMessage();
                    }
                });

                chatInput.addEventListener('input', () => {
                    chatInput.style.height = 'auto';
                    chatInput.style.height = Math.min(chatInput.scrollHeight, 120) + 'px';
                });

                sendBtn.addEventListener('click', () => {
                    this.sendMessage();
                });
            }

            async loadChallengesByCourse(course) {
                const topicSelect = document.getElementById('topic-select');
                
                if (!course) {
                    topicSelect.innerHTML = '<option value="">Select Topic</option>';
                    topicSelect.disabled = true;
                    this.clearContent();
                    return;
                }

                // Show loading state
                topicSelect.innerHTML = '<option value="">Loading topics...</option>';
                topicSelect.disabled = true;

                try {
                    const mockChallenges = await this.fetchChallenges(course);
                    
                    this.challenges = mockChallenges;
                    
                    if (mockChallenges.length > 0) {
                        this.populateTopicDropdown(mockChallenges);
                        topicSelect.disabled = false;
                        
                        // Auto-select first topic
                        const firstChallengeId = mockChallenges[0].id;
                        topicSelect.value = firstChallengeId;
                        this.loadChallengeByTopic(firstChallengeId);
                    } else {
                        topicSelect.innerHTML = '<option value="">No topics available</option>';
                        topicSelect.disabled = true;
                        this.clearContent();
                    }
                } catch (error) {
                    console.error('Error loading challenges:', error);
                    topicSelect.innerHTML = '<option value="">Failed to load topics</option>';
                    topicSelect.disabled = true;
                    this.clearContent();
                }
            }

            async fetchChallenges(course) {
                try {
                    const response = await fetch(`/challenges/api/challenges?course=${course}`);
                    const result = await response.json();
                    
                    if (result.success) {
                        return result.data;
                    } else {
                        console.error('Error fetching challenges:', result.error);
                        throw new Error(result.error || 'Failed to fetch challenges');
                    }
                } catch (error) {
                    console.error('Network error fetching challenges:', error);
                    
                    // Fallback to mock data if API fails
                    const mockData = {
                        python_full_stack: [
                            { id: 1, topic: "Basic Python Syntax", challenge_url: "https://onecompiler.com/embed/python" },
                            { id: 2, topic: "Data Structures", challenge_url: "https://onecompiler.com/embed/python" },
                            { id: 3, topic: "Flask Basics", challenge_url: "https://onecompiler.com/embed/python" },
                            { id: 4, topic: "Django Models", challenge_url: "https://onecompiler.com/embed/python" },
                            { id: 5, topic: "API Development", challenge_url: "https://onecompiler.com/embed/python" }
                        ],
                        java_fullstack: [
                            { id: 6, topic: "Java Fundamentals", challenge_url: "https://onecompiler.com/embed/java" },
                            { id: 7, topic: "Spring Boot", challenge_url: "https://onecompiler.com/embed/java" },
                            { id: 8, topic: "REST APIs", challenge_url: "https://onecompiler.com/embed/java" }
                        ],
                        data_science: [
                            { id: 9, topic: "Pandas Basics", challenge_url: "https://onecompiler.com/embed/python" },
                            { id: 10, topic: "Data Visualization", challenge_url: "https://onecompiler.com/embed/python" },
                            { id: 11, topic: "Machine Learning", challenge_url: "https://onecompiler.com/embed/python" }
                        ],
                        digital_marketing: [
                            { id: 12, topic: "Analytics with Python", challenge_url: "https://onecompiler.com/embed/python" },
                            { id: 13, topic: "SEO Tools", challenge_url: "https://onecompiler.com/embed/python" }
                        ],
                        cybersecurity: [
                            { id: 14, topic: "Security Scripts", challenge_url: "https://onecompiler.com/embed/python" },
                            { id: 15, topic: "Network Analysis", challenge_url: "https://onecompiler.com/embed/python" }
                        ],
                        data_analytics: [
                            { id: 16, topic: "Data Processing", challenge_url: "https://onecompiler.com/embed/python" },
                            { id: 17, topic: "Statistical Analysis", challenge_url: "https://onecompiler.com/embed/python" }
                        ]
                    };

                    const fallbackData = mockData[course] || [];
                    if (fallbackData.length === 0) {
                        throw new Error('No challenges available for this course');
                    }
                    return fallbackData;
                }
            }

            populateTopicDropdown(challenges) {
                const topicSelect = document.getElementById('topic-select');
                topicSelect.innerHTML = '';
                
                if (challenges.length === 0) {
                    topicSelect.innerHTML = '<option value="">No topics available</option>';
                    return;
                }
                
                challenges.forEach((challenge, index) => {
                    const option = document.createElement('option');
                    option.value = challenge.id;
                    option.textContent = challenge.topic;
                    // Select first option by default
                    if (index === 0) {
                        option.selected = true;
                    }
                    topicSelect.appendChild(option);
                });
            }

            loadChallengeByTopic(challengeId) {
                if (!challengeId) {
                    this.clearContent();
                    return;
                }

                const challenge = this.challenges.find(c => c.id == challengeId);
                if (challenge) {
                    this.currentChallenge = challenge;
                    this.loadChallengeContent(challenge);
                    
                    // Reset content tracking for new challenge
                    this.currentCodeContent = null;
                    this.currentQuestionText = null;
                    
                    // Clear any existing interval
                    if (this.contentCheckInterval) {
                        clearInterval(this.contentCheckInterval);
                    }
                }
            }

            loadChallengeContent(challenge) {
                const codeTab = document.getElementById('code-tab');
                const readTab = document.getElementById('read-tab');
                
                // Load challenge URL in code tab with message passing
                codeTab.innerHTML = `
                    <iframe
                        id="code-iframe"
                        class="content-iframe"
                        src="${challenge.challenge_url}"
                        frameBorder="0"
                        allow="fullscreen">
                    </iframe>
                `;

                // Set up message listener for code content
                this.setupCodeEditorListener();

                // Update read tab with documentation (placeholder)
                readTab.innerHTML = `
                    <iframe
                        class="content-iframe"
                        src="https://met.gitbook.io/python"
                        allow="fullscreen">
                    </iframe>
                `;
            }

            setupCodeEditorListener() {
                // Listen for messages from the code editor iframe
                window.addEventListener('message', (event) => {
                    if (event.data && event.data.type === 'code-content') {
                        this.currentCodeContent = event.data.code;
                    }
                    if (event.data && event.data.type === 'question-content') {
                        this.currentQuestionText = event.data.question;
                    }
                });

                // Try to get code and question content from OneCompiler
                setTimeout(() => {
                    this.tryGetEditorContent();
                }, 2000);

                // Periodically try to get content (in case it loads later)
                this.contentCheckInterval = setInterval(() => {
                    this.tryGetEditorContent();
                }, 5000);
            }

            tryGetEditorContent() {
                try {
                    const iframe = document.getElementById('code-iframe');
                    if (iframe && iframe.contentWindow) {
                        // Try to communicate with the iframe to get both code and question content
                        iframe.contentWindow.postMessage({ type: 'get-content' }, '*');
                    }
                } catch (error) {
                    console.log('Cannot access iframe content due to CORS restrictions');
                }
            }

            getCurrentQuestionText() {
                // Try multiple approaches to get question text from .md-view element
                
                // 1. From stored content (if iframe sends updates)
                if (this.currentQuestionText) {
                    return this.currentQuestionText;
                }

                // 2. Try to access iframe directly for .md-view element
                try {
                    const iframe = document.getElementById('code-iframe');
                    if (iframe && iframe.contentDocument) {
                        const questionElement = iframe.contentDocument.querySelector('div.md-view p');
                        if (questionElement) {
                            const questionText = questionElement.textContent || questionElement.innerText || '';
                            if (questionText.trim()) {
                                this.currentQuestionText = questionText.trim();
                                console.log(this.currentQuestionText)
                                return this.currentQuestionText;
                            }
                        }
                    }
                } catch (error) {
                    console.log('Cannot access iframe .md-view content directly');
                }

                // 3. Fallback to challenge topic if no question text found
                if (this.currentChallenge && this.currentChallenge.topic) {
                    return `Challenge: ${this.currentChallenge.topic}`;
                }

                return null;
            }

            getCurrentCodeContent() {
                // Try multiple approaches to get code content
                
                // 1. From stored content (if iframe sends updates)
                if (this.currentCodeContent) {
                    return this.currentCodeContent;
                }

                // 2. Try to access iframe directly (might fail due to CORS)
                try {
                    const iframe = document.getElementById('code-iframe');
                    if (iframe && iframe.contentDocument) {
                        // Look for common code editor elements
                        const codeElements = iframe.contentDocument.querySelectorAll(
                            'textarea, .CodeMirror-code, .ace_editor, [contenteditable="true"], .monaco-editor, #editor'
                        );
                        
                        for (let element of codeElements) {
                            let codeText = '';
                            
                            if (element.value) {
                                codeText = element.value;
                            } else if (element.textContent) {
                                codeText = element.textContent;
                            } else if (element.innerText) {
                                codeText = element.innerText;
                            }
                            
                            if (codeText.trim()) {
                                this.currentCodeContent = codeText.trim();
                                return this.currentCodeContent;
                            }
                        }
                    }
                } catch (error) {
                    console.log('Cannot access iframe code content directly');
                }

                // 3. Fallback message
                return '[Code editor content not accessible due to security restrictions. Please copy and paste your code in the chat if you need help with specific code.]';
            }

            clearContent() {
                const codeTab = document.getElementById('code-tab');
                const readTab = document.getElementById('read-tab');
                
                codeTab.innerHTML = `
                    <div class="empty-state">
                        <svg class="empty-icon" viewBox="0 0 24 24" fill="currentColor">
                            <path d="M9.4 16.6L4.8 12l4.6-4.6L8 6l-6 6 6 6 1.4-1.4zm5.2 0L19.2 12l-4.6-4.6L16 6l6 6-6 6-1.4-1.4z"/>
                        </svg>
                        <h3 class="empty-title">Select Challenge</h3>
                        <p class="empty-description">
                            Choose a course and topic above to load the coding challenge.
                        </p>
                    </div>
                `;

                readTab.innerHTML = `
                    <div class="empty-state">
                        <svg class="empty-icon" viewBox="0 0 24 24" fill="currentColor">
                            <path d="M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm-5 14H7v-2h7v2zm3-4H7v-2h10v2zm0-4H7V7h10v2z"/>
                        </svg>
                        <h3 class="empty-title">Documentation</h3>
                        <p class="empty-description">
                            Select a course and topic to view documentation and learning materials.
                        </p>
                    </div>
                `;
            }

            switchTab(tabName) {
                // Remove active class from all tabs and buttons
                document.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('active'));
                document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
                
                // Add active class to selected tab and button
                document.querySelector(`[onclick="switchTab('${tabName}')"]`).classList.add('active');
                document.getElementById(`${tabName}-tab`).classList.add('active');
            }

            addSystemMessage(message) {
                const messagesContainer = document.getElementById('chat-messages');
                const welcomeDiv = messagesContainer.querySelector('.chat-welcome');
                if (welcomeDiv) {
                    welcomeDiv.remove();
                }

                const messageDiv = document.createElement('div');
                messageDiv.className = 'chat-message assistant';
                messageDiv.innerHTML = `
                    <div class="message-avatar assistant">AI</div>
                    <div class="message-content">${message}</div>
                `;
                messagesContainer.appendChild(messageDiv);
                messagesContainer.scrollTop = messagesContainer.scrollHeight;
            }

            addUserMessage(message) {
                const messagesContainer = document.getElementById('chat-messages');
                const welcomeDiv = messagesContainer.querySelector('.chat-welcome');
                if (welcomeDiv) {
                    welcomeDiv.remove();
                }

                const messageDiv = document.createElement('div');
                messageDiv.className = 'chat-message user';
                messageDiv.innerHTML = `
                    <div class="message-avatar user">U</div>
                    <div class="message-content">${this.formatMessage(message)}</div>
                `;
                messagesContainer.appendChild(messageDiv);
                messagesContainer.scrollTop = messagesContainer.scrollHeight;
            }

            addAssistantMessage(message) {
                const messagesContainer = document.getElementById('chat-messages');
                
                const messageDiv = document.createElement('div');
                messageDiv.className = 'chat-message assistant';
                messageDiv.innerHTML = `
                    <div class="message-avatar assistant">AI</div>
                    <div class="message-content">${this.formatMessage(message)}</div>
                `;
                messagesContainer.appendChild(messageDiv);
                messagesContainer.scrollTop = messagesContainer.scrollHeight;
            }

            showTypingIndicator() {
                const messagesContainer = document.getElementById('chat-messages');
                
                const typingDiv = document.createElement('div');
                typingDiv.className = 'chat-message assistant';
                typingDiv.id = 'typing-indicator';
                typingDiv.innerHTML = `
                    <div class="message-avatar assistant">AI</div>
                    <div class="typing-indicator">
                        <div class="typing-dot"></div>
                        <div class="typing-dot"></div>
                        <div class="typing-dot"></div>
                    </div>
                `;
                messagesContainer.appendChild(typingDiv);
                messagesContainer.scrollTop = messagesContainer.scrollHeight;
            }

            hideTypingIndicator() {
                const typingIndicator = document.getElementById('typing-indicator');
                if (typingIndicator) {
                    typingIndicator.remove();
                }
            }

            formatMessage(message) {
                // Basic markdown-like formatting
                return message
                    .replace(/`([^`]+)`/g, '<code>$1</code>')
                    .replace(/```([^```]+)```/g, '<pre><code>$1</code></pre>')
                    .replace(/\*\*([^*]+)\*\*/g, '<strong>$1</strong>')
                    .replace(/\*([^*]+)\*/g, '<em>$1</em>')
                    .replace(/\n/g, '<br>');
            }

            async sendMessage() {
                const input = document.getElementById('chat-input');
                const sendBtn = document.getElementById('chat-send-btn');
                const message = input.value.trim();

                if (!message || this.isTyping) return;

                // Add user message
                this.addUserMessage(message);
                input.value = '';
                input.style.height = 'auto';

                // Disable input while processing
                this.isTyping = true;
                sendBtn.disabled = true;
                this.showTypingIndicator();

                try {
                    // Use Puter.js for real AI responses
                    if (typeof puter !== 'undefined' && puter.ai) {
                        console.log('Using Puter.js AI...');
                        
                        // Get current code content and question text from editor
                        const currentCode = this.getCurrentCodeContent();
                        const questionText = this.getCurrentQuestionText();
                        
                        // Create comprehensive context-aware prompt
                        let codingPrompt = `You are a helpful coding & syntax assistant for Medha EduTech students. 
                        Help with programming questions, explain concepts clearly, provide practical examples, and keep responses concise but informative.
                        Focus on programming concepts and best practices. Don't provide complete solutions but guide students toward understanding.
                        
                        Student question: ${message}`;

                        // Add current challenge context if available
                        if (this.currentChallenge) {
                            codingPrompt += `\n\nCurrent challenge: "${this.currentChallenge.topic}"`;
                        }

                        // Add the actual challenge question/problem statement
                        if (questionText) {
                            codingPrompt += `\n\nChallenge problem statement:\n${questionText}`;
                        }

                        // Add current code content if available
                        codingPrompt += `\n\nPlease provide helpful guidance based on the context above. Focus on helping the student understand the concepts and approach to solve the problem.`;

                        const response = await puter.ai.chat(codingPrompt, { 
                            model: "gpt-4.1-nano" 
                        });
                        
                        console.log('Puter AI Response:', response);
                        
                        this.hideTypingIndicator();
                        
                        // Extract the actual message content from the response structure
                        let aiMessage = '';
                        
                        if (response) {
                            if (response.result && response.result.message && response.result.message.content) {
                                aiMessage = response.result.message.content;
                            } else if (response.message && response.message.content) {
                                aiMessage = response.message.content;
                            } else if (response.content) {
                                aiMessage = response.content;
                            } else if (typeof response === 'string') {
                                aiMessage = response;
                            } else {
                                console.error('Unexpected response structure:', JSON.stringify(response, null, 2));
                                aiMessage = 'I received a response but couldn\'t parse it properly. Please try again.';
                            }
                        } else {
                            aiMessage = 'No response received from the AI service.';
                        }
                        
                        console.log('Extracted AI message:', aiMessage);
                        this.addAssistantMessage(aiMessage);
                        
                    } else {
                        throw new Error('Puter.js not available');
                    }
                } catch (error) {
                    console.error('Error calling Puter AI:', error);
                    this.hideTypingIndicator();
                    this.addAssistantMessage("Sorry, I'm having trouble connecting to the AI service right now. Please try again in a moment.");
                }

                // Re-enable input
                this.isTyping = false;
                sendBtn.disabled = false;
            }
        }

        // Global functions
        function switchTab(tabName) {
            window.medhaCode.switchTab(tabName);
        }

        function sendMessage() {
            window.medhaCode.sendMessage();
        }

        // Initialize the application
        document.addEventListener('DOMContentLoaded', () => {
            window.medhaCode = new MedhaCode();
        });
    </script>
</body>
</html>